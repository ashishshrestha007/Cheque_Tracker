<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deposit | ChequeTracker</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #0052CC;
            --primary-hover: #0065FF;
            --primary-light: rgba(0, 82, 204, 0.08);
            --accent: #0065FF;
            --text-primary: #172B4D;
            --text-secondary: #5E6C84;
            --text-muted: #97A0AF;
            --bg-primary: #FFFFFF;
            --bg-secondary: #F4F5F7;
            --bg-tertiary: #EBECF0;
            --border: #DFE1E6;
            --success: #00875A;
            --success-light: rgba(0, 135, 90, 0.1);
            --error: #DE350B;
            --error-light: rgba(222, 53, 11, 0.1);
            --warning: #FF991F;
            --warning-light: rgba(255, 153, 31, 0.1);
            --info: #0065FF;
            --shadow-sm: 0 1px 2px rgba(9,30,66,0.08);
            --shadow-md: 0 4px 8px rgba(9,30,66,0.1);
            --shadow-lg: 0 8px 16px rgba(9,30,66,0.12);
            --shadow-xl: 0 16px 32px rgba(9,30,66,0.15);
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            --transition: all 0.2s ease;
            --header-bg: linear-gradient(135deg, #0052CC 0%, #0747A6 100%);
            --sidebar-width: 260px;
        }
        [data-theme="dark"] {
            --primary: #4C9AFF;
            --primary-hover: #79B8FF;
            --primary-light: rgba(76,154,255,0.12);
            --text-primary: #E6E8EB;
            --text-secondary: #B8C1CC;
            --text-muted: #8C95A0;
            --bg-primary: #161B22;
            --bg-secondary: #0D1117;
            --bg-tertiary: #21262D;
            --border: #30363D;
            --success-light: rgba(0,135,90,0.2);
            --error-light: rgba(222,53,11,0.2);
            --warning-light: rgba(255,153,31,0.2);
            --header-bg: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-secondary); min-height: 100vh; color: var(--text-primary); transition: var(--transition); -webkit-font-smoothing: antialiased; }

        /* ===== SIDEBAR ===== */
        .sidebar { position: fixed; left: 0; top: 0; bottom: 0; width: var(--sidebar-width); background: var(--header-bg); padding: 24px 0; z-index: 100; overflow: hidden; }
        .sidebar::before { content:''; position:absolute; top:0;left:0;right:0;bottom:0; background-image: radial-gradient(rgba(255,255,255,0.03) 1px, transparent 1px); background-size:20px 20px; pointer-events:none; }
        .sidebar-shapes { position:absolute; top:0;left:0;right:0;bottom:0; overflow:hidden; pointer-events:none; }
        .sidebar-circle { position:absolute; border-radius:50%; background:linear-gradient(135deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.02) 100%); border:1px solid rgba(255,255,255,0.05); }
        .sidebar-circle-1 { width:150px;height:150px;top:-50px;right:-50px; animation:float1 20s ease-in-out infinite; }
        .sidebar-circle-2 { width:100px;height:100px;bottom:20%;left:-30px; animation:float2 25s ease-in-out infinite; }
        .sidebar-circle-3 { width:80px;height:80px;bottom:-20px;right:20px; animation:float3 18s ease-in-out infinite; }
        @keyframes float1{0%,100%{transform:translate(0,0)}50%{transform:translate(-10px,20px)}}
        @keyframes float2{0%,100%{transform:translate(0,0)}50%{transform:translate(20px,-15px)}}
        @keyframes float3{0%,100%{transform:translate(0,0)}50%{transform:translate(-15px,-10px)}}
        .sidebar-logo { display:flex;align-items:center;gap:12px;padding:0 24px;margin-bottom:32px;position:relative;z-index:1; }
        .sidebar-logo .logo-icon { width:42px;height:42px;background:rgba(255,255,255,0.15);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.2);border-radius:12px;display:flex;align-items:center;justify-content:center; }
        .sidebar-logo .logo-icon svg { width:22px;height:22px;fill:white; }
        .sidebar-logo .logo-text { display:flex;flex-direction:column; }
        .sidebar-logo .logo-text span:first-child { font-size:18px;font-weight:700;color:white;letter-spacing:-0.3px; }
        .sidebar-logo .logo-text span:last-child { font-size:10px;color:rgba(255,255,255,0.6);letter-spacing:1px;text-transform:uppercase; }
        .sidebar-nav { padding:0 12px;position:relative;z-index:1; }
        .nav-section { margin-bottom:24px; }
        .nav-section-title { font-size:10px;font-weight:600;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:1.5px;padding:0 12px;margin-bottom:8px; }
        .nav-item { display:flex;align-items:center;gap:12px;padding:12px 16px;border-radius:var(--radius-md);color:rgba(255,255,255,0.7);text-decoration:none;font-size:14px;font-weight:500;transition:var(--transition);margin-bottom:4px; }
        .nav-item:hover { background:rgba(255,255,255,0.1);color:white; }
        .nav-item.active { background:rgba(255,255,255,0.15);color:white; }
        .nav-item svg { width:20px;height:20px;fill:currentColor;flex-shrink:0; }
        .nav-item .badge { margin-left:auto;background:rgba(255,255,255,0.2);color:white;font-size:11px;font-weight:600;padding:2px 8px;border-radius:10px; }
        .nav-item .badge.alert { background:var(--error); }
        .sidebar-footer { position:absolute;bottom:24px;left:12px;right:12px;z-index:1; }
        .sidebar-user { display:flex;align-items:center;gap:12px;padding:12px;background:rgba(255,255,255,0.1);border-radius:var(--radius-lg);margin-bottom:12px; }
        .sidebar-user-avatar { width:40px;height:40px;background:linear-gradient(135deg, #4C9AFF 0%, #00C7E6 100%);border-radius:10px;display:flex;align-items:center;justify-content:center; }
        .sidebar-user-avatar svg { width:20px;height:20px;fill:white; }
        .sidebar-user-info { flex:1;min-width:0; }
        .sidebar-user-name { font-size:13px;font-weight:600;color:white;white-space:nowrap;overflow:hidden;text-overflow:ellipsis; }
        .sidebar-user-role { font-size:11px;color:rgba(255,255,255,0.6); }
        .logout-btn { display:flex;align-items:center;justify-content:center;gap:8px;width:100%;padding:12px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.1);border-radius:var(--radius-md);color:rgba(255,255,255,0.8);font-size:13px;font-weight:500;cursor:pointer;transition:var(--transition);text-decoration:none; }
        .logout-btn:hover { background:rgba(255,255,255,0.15);color:white; }
        .logout-btn svg { width:18px;height:18px;fill:currentColor; }

        /* ===== MAIN ===== */
        .main-wrapper { margin-left:var(--sidebar-width);min-height:100vh; }
        .header { background:var(--bg-primary);border-bottom:1px solid var(--border);padding:16px 32px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50; }
        .header-left { display:flex;flex-direction:column; }
        .header-title { font-size:24px;font-weight:700;color:var(--text-primary);letter-spacing:-0.5px; }
        .header-subtitle { font-size:13px;color:var(--text-secondary);margin-top:2px; }
        .header-right { display:flex;align-items:center;gap:16px; }
        .header-datetime { text-align:right;padding-right:16px;border-right:1px solid var(--border); }
        .header-time { font-size:20px;font-weight:700;color:var(--text-primary); }
        .header-date { font-size:12px;color:var(--text-secondary); }
        .header-actions { display:flex;align-items:center;gap:8px; }
        .header-btn { width:40px;height:40px;border-radius:var(--radius-md);border:1px solid var(--border);background:var(--bg-primary);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:var(--transition);position:relative; }
        .header-btn:hover { background:var(--bg-secondary); }
        .header-btn svg { width:20px;height:20px;fill:var(--text-secondary); }
        .header-btn .badge { position:absolute;top:-4px;right:-4px;min-width:18px;height:18px;background:var(--error);color:white;font-size:10px;font-weight:700;border-radius:9px;display:flex;align-items:center;justify-content:center;padding:0 4px; }
        .theme-toggle .sun { display:none; }
        [data-theme="dark"] .theme-toggle .sun { display:block; }
        [data-theme="dark"] .theme-toggle .moon { display:none; }

        .main-content { padding:24px 32px;max-width:1400px;margin:0 auto; }

        /* ===== QUICK STATS ===== */
        .quick-stats { display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px; }
        .quick-stat-card { background:var(--bg-primary);border:1px solid var(--border);border-radius:var(--radius-lg);padding:20px;display:flex;align-items:center;gap:16px;transition:var(--transition); }
        .quick-stat-card:hover { box-shadow:var(--shadow-md);transform:translateY(-2px); }
        .quick-stat-icon { width:48px;height:48px;border-radius:var(--radius-md);display:flex;align-items:center;justify-content:center; }
        .quick-stat-icon svg { width:24px;height:24px;fill:white; }
        .quick-stat-icon.blue { background:linear-gradient(135deg,#0052CC,#0747A6); }
        .quick-stat-icon.green { background:linear-gradient(135deg,#00875A,#006644); }
        .quick-stat-icon.orange { background:linear-gradient(135deg,#FF991F,#FF8B00); }
        .quick-stat-icon.purple { background:linear-gradient(135deg,#6554C0,#5243AA); }
        .quick-stat-content h4 { font-size:22px;font-weight:800;color:var(--text-primary); }
        .quick-stat-content p { font-size:12px;color:var(--text-muted);margin-top:2px; }

        /* ===== STEP INDICATOR ===== */
        .step-indicator { display:flex;align-items:center;justify-content:center;gap:0;margin-bottom:32px;background:var(--bg-primary);border:1px solid var(--border);border-radius:var(--radius-xl);padding:24px 40px; }
        .step { display:flex;align-items:center;gap:12px; }
        .step-number { width:40px;height:40px;border-radius:50%;background:var(--bg-tertiary);border:2px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:700;color:var(--text-muted);transition:var(--transition); }
        .step.active .step-number { background:var(--primary);border-color:var(--primary);color:white; }
        .step.completed .step-number { background:var(--success);border-color:var(--success);color:white; }
        .step.last .step-number { background:var(--warning);border-color:var(--warning);color:white; }
        .step-info { display:flex;flex-direction:column; }
        .step-title { font-size:14px;font-weight:600;color:var(--text-muted);transition:var(--transition); }
        .step.active .step-title, .step.completed .step-title { color:var(--text-primary); }
        .step-subtitle { font-size:12px;color:var(--text-muted); }
        .step-connector { width:80px;height:2px;background:var(--border);margin:0 20px; }
        .step-connector.active { background:var(--primary); }

        /* ===== DEPOSIT MODE TABS ===== */
        .deposit-mode-tabs { display:flex;gap:0;margin-bottom:24px;background:var(--bg-primary);border:1px solid var(--border);border-radius:var(--radius-xl);overflow:hidden; }
        .deposit-mode-tab { flex:1;display:flex;align-items:center;justify-content:center;gap:10px;padding:18px 24px;cursor:pointer;font-size:14px;font-weight:600;color:var(--text-muted);border:none;background:transparent;transition:var(--transition);border-bottom:3px solid transparent;font-family:inherit; }
        .deposit-mode-tab:hover { background:var(--bg-secondary);color:var(--text-primary); }
        .deposit-mode-tab.active { color:var(--primary);border-bottom-color:var(--primary);background:var(--primary-light); }
        .deposit-mode-tab svg { width:20px;height:20px;fill:currentColor; }
        .deposit-mode-tab .tab-badge { background:var(--primary);color:white;font-size:10px;font-weight:700;padding:2px 8px;border-radius:10px; }

        /* ===== CONTENT LAYOUT ===== */
        .content-layout { display:grid;grid-template-columns:1fr 440px;gap:24px; }

        /* ===== PENDING CHEQUES ===== */
        .pending-cheques-section { background:var(--bg-primary);border:1px solid var(--border);border-radius:var(--radius-xl);overflow:hidden; }
        .section-header { display:flex;align-items:center;justify-content:space-between;padding:20px 24px;background:var(--bg-secondary);border-bottom:1px solid var(--border); }
        .section-header-left { display:flex;align-items:center;gap:16px; }
        .section-header-icon { width:44px;height:44px;border-radius:var(--radius-md);display:flex;align-items:center;justify-content:center; }
        .section-header-icon svg { width:22px;height:22px;fill:white; }
        .section-header-icon.blue { background:linear-gradient(135deg,#0052CC,#0747A6); }
        .section-header-icon.green { background:linear-gradient(135deg,#00875A,#006644); }
        .section-header-icon.orange { background:linear-gradient(135deg,#FF991F,#FF8B00); }
        .section-header h3 { font-size:16px;font-weight:700;color:var(--text-primary); }
        .section-header p { font-size:12px;color:var(--text-muted);margin-top:2px; }
        .section-header-right { display:flex;align-items:center;gap:12px; }
        .select-all-wrapper { display:flex;align-items:center;gap:8px;padding:8px 16px;background:var(--bg-primary);border:1px solid var(--border);border-radius:var(--radius-md);cursor:pointer;transition:var(--transition); }
        .select-all-wrapper:hover { border-color:var(--primary); }
        .select-all-wrapper input[type="checkbox"] { width:18px;height:18px;cursor:pointer;accent-color:var(--primary); }
        .select-all-wrapper label { font-size:13px;font-weight:500;color:var(--text-primary);cursor:pointer; }
        .cheque-list { max-height:600px;overflow-y:auto; }
        .cheque-item { display:flex;align-items:center;gap:16px;padding:16px 24px;border-bottom:1px solid var(--border);transition:var(--transition);cursor:pointer; }
        .cheque-item:hover { background:var(--bg-secondary); }
        .cheque-item.selected { background:var(--primary-light);border-left:3px solid var(--primary); }
        .cheque-item:last-child { border-bottom:none; }
        .cheque-checkbox { width:22px;height:22px;cursor:pointer;accent-color:var(--primary);flex-shrink:0; }
        .cheque-info { flex:1;display:grid;grid-template-columns:1fr 1fr 1fr 130px;gap:16px;align-items:center; }
        .cheque-detail { display:flex;flex-direction:column;gap:2px; }
        .cheque-detail-label { font-size:10px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px; }
        .cheque-detail-value { font-size:13px;font-weight:600;color:var(--text-primary); }
        .cheque-detail-value.highlight { color:var(--primary); }
        .cheque-detail-value.amount { color:var(--success);font-size:14px;font-weight:700; }
        .empty-state { padding:60px 24px;text-align:center; }
        .empty-state-icon { width:80px;height:80px;border-radius:50%;background:var(--bg-secondary);display:flex;align-items:center;justify-content:center;margin:0 auto 20px; }
        .empty-state-icon svg { width:40px;height:40px;fill:var(--text-muted); }
        .empty-state h4 { font-size:16px;font-weight:600;color:var(--text-primary);margin-bottom:8px; }
        .empty-state p { font-size:13px;color:var(--text-muted); }

        /* ===== DEPOSIT FORM ===== */
        .deposit-form-section { background:var(--bg-primary);border:1px solid var(--border);border-radius:var(--radius-xl);overflow:hidden;position:sticky;top:100px; }
        .deposit-form-header { background:linear-gradient(135deg,#00875A 0%,#006644 100%);padding:20px 24px; }
        .deposit-form-header h3 { font-size:16px;font-weight:700;color:white;display:flex;align-items:center;gap:10px; }
        .deposit-form-header h3 svg { width:20px;height:20px;fill:white; }
        .deposit-form-header p { font-size:12px;color:rgba(255,255,255,0.7);margin-top:4px; }
        .deposit-form-header.multi-bank { background:linear-gradient(135deg,#6554C0 0%,#5243AA 100%); }

        /* ===== SELECTED SUMMARY ===== */
        .selected-summary { padding:16px 24px;background:var(--bg-secondary);border-bottom:1px solid var(--border); }
        .selected-summary-title { font-size:11px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:10px; }
        .selected-stats { display:grid;grid-template-columns:1fr 1fr;gap:10px; }
        .selected-stat { background:var(--bg-primary);border:1px solid var(--border);border-radius:var(--radius-md);padding:10px;text-align:center; }
        .selected-stat-value { font-size:20px;font-weight:800;color:var(--primary); }
        .selected-stat-value.amount { color:var(--success);font-size:15px; }
        .selected-stat-label { font-size:11px;color:var(--text-muted);margin-top:3px; }

        /* ===== SELECTED CHEQUES BREAKDOWN TABLE ===== */
        .selected-cheques-breakdown {
            border-top: 1px solid var(--border);
            background: var(--bg-secondary);
        }
        .breakdown-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 20px;
            cursor: pointer;
            user-select: none;
            transition: var(--transition);
        }
        .breakdown-header:hover { background: var(--bg-tertiary); }
        .breakdown-header-left {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.6px;
        }
        .breakdown-header-left svg { width: 16px; height: 16px; fill: currentColor; }
        .breakdown-count-pill {
            background: var(--primary);
            color: white;
            font-size: 10px;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 10px;
            letter-spacing: 0;
            text-transform: none;
        }
        .breakdown-toggle-icon {
            width: 20px; height: 20px;
            fill: var(--text-muted);
            transition: transform 0.2s ease;
        }
        .breakdown-toggle-icon.open { transform: rotate(180deg); }

        .breakdown-body {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.35s ease;
        }
        .breakdown-body.open { max-height: 320px; overflow-y: auto; }

        .breakdown-empty {
            padding: 20px;
            text-align: center;
            font-size: 12px;
            color: var(--text-muted);
            font-style: italic;
        }

        .breakdown-table {
            width: 100%;
            border-collapse: collapse;
        }
        .breakdown-table thead tr {
            background: var(--bg-tertiary);
        }
        .breakdown-table th {
            padding: 8px 14px;
            font-size: 10px;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        .breakdown-table td {
            padding: 9px 14px;
            font-size: 12px;
            color: var(--text-primary);
            border-bottom: 1px solid var(--border);
        }
        .breakdown-table tbody tr:hover { background: var(--bg-primary); }
        .breakdown-table tbody tr:last-child td { border-bottom: none; }
        .breakdown-cheque-no { font-weight: 700; color: var(--primary); }
        .breakdown-amount { font-weight: 700; color: var(--success); white-space: nowrap; }
        .breakdown-bank { font-size: 11px; color: var(--text-secondary); }
        .breakdown-name { font-size: 12px; font-weight: 500; max-width: 100px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .breakdown-remove-btn {
            width: 22px; height: 22px;
            border: none;
            background: var(--error-light);
            border-radius: 50%;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: var(--transition);
            padding: 0;
        }
        .breakdown-remove-btn svg { width: 12px; height: 12px; fill: var(--error); }
        .breakdown-remove-btn:hover { background: var(--error); }
        .breakdown-remove-btn:hover svg { fill: white; }

        .breakdown-total-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 14px;
            background: linear-gradient(135deg, rgba(0,135,90,0.08) 0%, rgba(0,135,90,0.04) 100%);
            border-top: 2px solid var(--success);
        }
        .breakdown-total-label {
            font-size: 12px;
            font-weight: 700;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .breakdown-total-label svg { width: 14px; height: 14px; fill: var(--success); }
        .breakdown-total-value {
            font-size: 16px;
            font-weight: 800;
            color: var(--success);
        }

        /* ===== FORM ===== */
        .deposit-form { padding: 20px 24px; }
        .form-group { margin-bottom: 16px; }
        .form-group:last-child { margin-bottom: 0; }
        .form-label { display:flex;align-items:center;gap:6px;font-size:13px;font-weight:600;color:var(--text-primary);margin-bottom:7px; }
        .form-label .required { color:var(--error);font-weight:700; }
        .form-input, .form-select, .form-textarea {
            width:100%;height:44px;padding:0 14px;
            background:var(--bg-primary);border:2px solid var(--border);
            border-radius:var(--radius-md);font-family:inherit;
            font-size:14px;font-weight:500;color:var(--text-primary);
            transition:var(--transition);outline:none;
        }
        .form-textarea { height:auto;min-height:72px;padding:10px 14px;resize:vertical; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { border-color:var(--primary);box-shadow:0 0 0 3px var(--primary-light); }
        .form-select { appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%2397A0AF'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;background-size:24px;padding-right:44px;cursor:pointer; }
        .form-row { display:grid;grid-template-columns:1fr 1fr;gap:14px; }
        .form-divider { height: 1px; background: var(--border); margin: 4px 0 18px; }

        /* ===== FORM SECTION DIVIDER ===== */
        .form-section-divider {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 14px;
        }
        .form-section-divider span {
            font-size: 11px;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            white-space: nowrap;
        }
        .form-section-divider small {
            font-size: 11px;
            color: var(--text-muted);
            font-style: italic;
            white-space: nowrap;
        }
        .form-section-divider::before,
        .form-section-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border);
        }
        .form-section-divider::after { display: none; }

        /* Autofilled input highlight */
        .form-input.autofilled {
            border-color: var(--primary);
            background: var(--primary-light);
            color: var(--text-primary);
            font-weight: 600;
        }
        .form-input.autofilled:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        /* ===== CHEQUE DETAIL AUTOFILL SECTION ===== */
        .cheque-autofill-section {
            background: var(--bg-secondary);
            border: 2px dashed var(--border);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 20px;
            transition: var(--transition);
            position: relative;
        }
        .cheque-autofill-section.has-data {
            border-style: solid;
            border-color: var(--primary);
            background: var(--primary-light);
        }
        .cheque-autofill-section.has-data .autofill-placeholder { display: none; }
        .cheque-autofill-section:not(.has-data) .autofill-fields { display: none; }

        .autofill-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 8px 0;
            text-align: center;
        }
        .autofill-placeholder-icon {
            width: 48px; height: 48px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            display: flex; align-items: center; justify-content: center;
        }
        .autofill-placeholder-icon svg { width: 24px; height: 24px; fill: var(--text-muted); }
        .autofill-placeholder h5 { font-size: 13px; font-weight: 600; color: var(--text-primary); }
        .autofill-placeholder p { font-size: 12px; color: var(--text-muted); }

        .autofill-section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 14px;
        }
        .autofill-section-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            font-weight: 700;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }
        .autofill-section-label svg { width: 14px; height: 14px; fill: var(--primary); }
        .autofill-source-tag {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 3px 10px;
            background: var(--primary);
            color: white;
            font-size: 10px;
            font-weight: 700;
            border-radius: 20px;
            letter-spacing: 0.3px;
        }
        .autofill-source-tag svg { width: 10px; height: 10px; fill: white; }

        .autofill-fields { display: flex; flex-direction: column; gap: 12px; }
        .autofill-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

        .autofill-field-group { display: flex; flex-direction: column; gap: 5px; }
        .autofill-field-label {
            font-size: 11px;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .autofill-field-label .edit-dot {
            width: 6px; height: 6px;
            border-radius: 50%;
            background: var(--success);
            display: inline-block;
        }
        .autofill-input {
            width: 100%;
            height: 40px;
            padding: 0 12px;
            background: var(--bg-primary);
            border: 1.5px solid var(--border);
            border-radius: var(--radius-md);
            font-family: inherit;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            transition: var(--transition);
            outline: none;
        }
        .autofill-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }
        .autofill-input.amount-input {
            color: var(--success);
            font-size: 14px;
            font-weight: 700;
        }
        .autofill-input.cheque-no-input {
            color: var(--primary);
            font-weight: 700;
        }
        .autofill-input[readonly] {
            background: var(--bg-tertiary);
            cursor: not-allowed;
            color: var(--text-muted);
        }

        .clear-autofill-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--error-light);
            border: 1px solid transparent;
            border-radius: var(--radius-md);
            font-family: inherit;
            font-size: 11px;
            font-weight: 600;
            color: var(--error);
            cursor: pointer;
            transition: var(--transition);
        }
        .clear-autofill-btn:hover { background: var(--error); color: white; }
        .clear-autofill-btn svg { width: 13px; height: 13px; fill: currentColor; }

        /* ===== FILE UPLOAD ===== */
        .file-upload-area { border:2px dashed var(--border);border-radius:var(--radius-lg);padding:20px;text-align:center;cursor:pointer;transition:var(--transition);position:relative;overflow:hidden;background:var(--bg-secondary); }
        .file-upload-area:hover, .file-upload-area.dragover { border-color:var(--primary);background:var(--primary-light); }
        .file-upload-area input[type="file"] { position:absolute;top:0;left:0;width:100%;height:100%;opacity:0;cursor:pointer; }
        .file-upload-icon { width:48px;height:48px;border-radius:50%;background:var(--bg-tertiary);display:flex;align-items:center;justify-content:center;margin:0 auto 10px; }
        .file-upload-icon svg { width:24px;height:24px;fill:var(--text-muted); }
        .file-upload-area h5 { font-size:13px;font-weight:600;color:var(--text-primary);margin-bottom:3px; }
        .file-upload-area h5 span { color:var(--primary); }
        .file-upload-area p { font-size:11px;color:var(--text-muted); }
        .uploaded-files { margin-top:10px;display:flex;flex-direction:column;gap:7px; }
        .uploaded-file-item { display:flex;align-items:center;gap:10px;padding:9px 12px;background:var(--bg-primary);border:1px solid var(--border);border-radius:var(--radius-md);transition:var(--transition); }
        .uploaded-file-item:hover { border-color:var(--primary); }
        .uploaded-file-thumb { width:40px;height:40px;border-radius:var(--radius-sm);overflow:hidden;flex-shrink:0;background:var(--bg-tertiary);display:flex;align-items:center;justify-content:center; }
        .uploaded-file-thumb img { width:100%;height:100%;object-fit:cover; }
        .uploaded-file-thumb svg { width:20px;height:20px;fill:var(--text-muted); }
        .uploaded-file-info { flex:1;min-width:0; }
        .uploaded-file-name { font-size:12px;font-weight:600;color:var(--text-primary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis; }
        .uploaded-file-size { font-size:11px;color:var(--text-muted); }
        .uploaded-file-remove { width:26px;height:26px;border-radius:50%;border:none;background:var(--error-light);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:var(--transition);flex-shrink:0; }
        .uploaded-file-remove:hover { background:var(--error); }
        .uploaded-file-remove svg { width:13px;height:13px;fill:var(--error); }
        .uploaded-file-remove:hover svg { fill:white; }

        /* ===== BUTTONS ===== */
        .btn { display:inline-flex;align-items:center;justify-content:center;gap:8px;height:46px;padding:0 22px;border-radius:var(--radius-md);font-family:inherit;font-size:14px;font-weight:600;cursor:pointer;transition:var(--transition);border:2px solid transparent;text-decoration:none; }
        .btn svg { width:18px;height:18px;fill:currentColor; }
        .btn-success { background:linear-gradient(135deg,#00875A 0%,#006644 100%);color:white;width:100%; }
        .btn-success:hover { transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,135,90,0.4); }
        .btn-success:disabled { opacity:0.5;cursor:not-allowed;transform:none;box-shadow:none; }
        .btn-excel { background:linear-gradient(135deg,#217346 0%,#185C37 100%);color:white; }
        .btn-excel:hover { transform:translateY(-2px);box-shadow:0 4px 12px rgba(33,115,70,0.4); }
        .form-actions { margin-top:20px; }

        /* ===== HISTORY TABLE ===== */
        .deposit-history-section { margin-top:24px;background:var(--bg-primary);border:1px solid var(--border);border-radius:var(--radius-xl);overflow:hidden; }
        .table-wrapper { overflow-x:auto; }
        .data-table { width:100%;border-collapse:collapse; }
        .data-table th, .data-table td { padding:14px 20px;text-align:left;border-bottom:1px solid var(--border); }
        .data-table th { background:var(--bg-secondary);font-size:11px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px; }
        .data-table td { font-size:13px;color:var(--text-primary); }
        .data-table tbody tr:hover { background:var(--bg-secondary); }
        .data-table tbody tr:last-child td { border-bottom:none; }
        .deposit-id { font-weight:700;color:var(--primary); }
        .deposit-amount { font-weight:700;color:var(--success); }
        .deposit-cheques-count { display:inline-flex;align-items:center;gap:6px;padding:4px 10px;background:var(--primary-light);color:var(--primary);border-radius:20px;font-size:12px;font-weight:600; }
        .table-status { display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:20px;font-size:15px;font-weight:600; color:var(--warning);}
        .table-status.processing { background:rgba(0,101,255,0.1);color:var(--info); }
        .table-status.completed { background:var(--success-light);color:var(--success); }
        .cheque-status-dot { width:6px;height:6px;border-radius:50%;background:currentColor; }
        .table-actions { display:flex;gap:8px; }
        .table-action-btn { width:32px;height:32px;border-radius:var(--radius-sm);border:1px solid var(--border);background:var(--bg-primary);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:var(--transition); }
        .table-action-btn:hover { background:var(--bg-secondary); }
        .table-action-btn svg { width:16px;height:16px;fill:var(--text-muted); }
        .table-action-btn.view:hover { border-color:var(--primary);background:var(--primary-light); }
        .table-action-btn.view:hover svg { fill:var(--primary); }
        .has-slip-icon { display:inline-flex;align-items:center;gap:4px;color:var(--success);font-size:12px;font-weight:600; }
        .has-slip-icon svg { width:16px;height:16px;fill:var(--success); }
        .no-slip-icon { color:var(--text-muted);font-size:12px; }

        /* ===== TOAST ===== */
        .toast-container { position:fixed;top:24px;right:24px;z-index:9999;display:flex;flex-direction:column;gap:12px; }
        .toast { display:flex;align-items:flex-start;gap:12px;padding:16px 20px;background:var(--bg-primary);border:1px solid var(--border);border-radius:var(--radius-lg);box-shadow:var(--shadow-xl);min-width:340px;max-width:420px;animation:slideInRight 0.3s ease-out; }
        @keyframes slideInRight{from{opacity:0;transform:translateX(100px)}to{opacity:1;transform:translateX(0)}}
        @keyframes slideOutRight{from{opacity:1;transform:translateX(0)}to{opacity:0;transform:translateX(100px)}}
        .toast.success { border-left:4px solid var(--success); }
        .toast.error { border-left:4px solid var(--error); }
        .toast.warning { border-left:4px solid var(--warning); }
        .toast-icon { width:40px;height:40px;border-radius:var(--radius-md);display:flex;align-items:center;justify-content:center;flex-shrink:0; }
        .toast-icon svg { width:20px;height:20px;fill:white; }
        .toast.success .toast-icon { background:linear-gradient(135deg,#00875A,#006644); }
        .toast.error .toast-icon { background:linear-gradient(135deg,#DE350B,#BF2600); }
        .toast.warning .toast-icon { background:linear-gradient(135deg,#FF991F,#FF8B00); }
        .toast-content { flex:1; }
        .toast-title { font-size:14px;font-weight:600;color:var(--text-primary);margin-bottom:3px; }
        .toast-message { font-size:12px;color:var(--text-muted);line-height:1.5; }
        .toast-close { width:26px;height:26px;border-radius:var(--radius-sm);border:none;background:transparent;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0; }
        .toast-close:hover { background:var(--bg-secondary); }
        .toast-close svg { width:15px;height:15px;fill:var(--text-muted); }

        /* ===== MODAL ===== */
        .modal-overlay { position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:10000;opacity:0;visibility:hidden;transition:var(--transition); }
        .modal-overlay.active { opacity:1;visibility:visible; }
        .modal { background:var(--bg-primary);border-radius:var(--radius-xl);max-width:720px;width:90%;max-height:85vh;overflow:hidden;transform:scale(0.9);transition:var(--transition); }
        .modal-overlay.active .modal { transform:scale(1); }
        .modal-header { display:flex;align-items:center;justify-content:space-between;padding:20px 24px;background:linear-gradient(135deg,#00875A 0%,#006644 100%); }
        .modal-header h3 { font-size:18px;font-weight:700;color:white; }
        .modal-close { width:36px;height:36px;border-radius:var(--radius-md);border:none;background:rgba(255,255,255,0.2);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:var(--transition); }
        .modal-close:hover { background:rgba(255,255,255,0.3); }
        .modal-close svg { width:20px;height:20px;fill:white; }
        .modal-body { padding:24px;max-height:calc(85vh - 130px);overflow-y:auto; }
        .modal-section { margin-bottom:24px; }
        .modal-section:last-child { margin-bottom:0; }
        .modal-section-title { font-size:12px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:12px;padding-bottom:8px;border-bottom:2px solid var(--border); }
        .modal-info-grid { display:grid;grid-template-columns:repeat(2,1fr);gap:14px; }
        .modal-info-item { background:var(--bg-secondary);padding:12px 16px;border-radius:var(--radius-md); }
        .modal-info-label { font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px; }
        .modal-info-value { font-size:14px;font-weight:600;color:var(--text-primary);margin-top:4px; }
        .modal-info-value.highlight { color:var(--primary); }
        .modal-info-value.amount { color:var(--success);font-size:18px;font-weight:700; }
        .modal-cheques-list { border:1px solid var(--border);border-radius:var(--radius-md);overflow:hidden; }
        .modal-cheque-item { display:grid;grid-template-columns:1fr 1fr 1fr 100px;gap:12px;padding:11px 16px;border-bottom:1px solid var(--border);font-size:13px; }
        .modal-cheque-item:last-child { border-bottom:none; }
        .modal-cheque-item.header { background:var(--bg-secondary);font-size:11px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px; }
        .modal-slip-grid { display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px; }
        .modal-slip-thumb { border-radius:var(--radius-md);overflow:hidden;border:1px solid var(--border);cursor:pointer;transition:var(--transition);aspect-ratio:4/3; }
        .modal-slip-thumb:hover { box-shadow:var(--shadow-md);border-color:var(--primary); }
        .modal-slip-thumb img { width:100%;height:100%;object-fit:cover; }

        /* ===== IMAGE PREVIEW ===== */
        .image-preview-overlay { position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);display:flex;align-items:center;justify-content:center;z-index:20000;opacity:0;visibility:hidden;transition:var(--transition);cursor:zoom-out; }
        .image-preview-overlay.active { opacity:1;visibility:visible; }
        .image-preview-overlay img { max-width:90%;max-height:90%;object-fit:contain;border-radius:var(--radius-md); }
        .image-preview-close { position:absolute;top:20px;right:20px;width:44px;height:44px;border-radius:50%;background:rgba(255,255,255,0.2);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center; }
        .image-preview-close svg { width:24px;height:24px;fill:white; }

        .footer { padding:20px 32px;border-top:1px solid var(--border);text-align:center; }
        .footer p { font-size:12px;color:var(--text-muted); }

        @media(max-width:1200px){.content-layout{grid-template-columns:1fr}.deposit-form-section{position:static}.quick-stats{grid-template-columns:repeat(2,1fr)}.cheque-info{grid-template-columns:1fr 1fr;gap:12px}}
        @media(max-width:1024px){.sidebar{transform:translateX(-100%)}.main-wrapper{margin-left:0}}
        @media(max-width:768px){.header{padding:12px 16px}.header-datetime{display:none}.main-content{padding:16px}.quick-stats{grid-template-columns:1fr}.form-row{grid-template-columns:1fr}.cheque-info{grid-template-columns:1fr}.deposit-mode-tabs{flex-direction:column}}
    </style>
</head>
<body>
    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="sidebar-shapes">
            <div class="sidebar-circle sidebar-circle-1"></div>
            <div class="sidebar-circle sidebar-circle-2"></div>
            <div class="sidebar-circle sidebar-circle-3"></div>
        </div>
        <div class="sidebar-logo">
            <div class="logo-icon"><svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg></div>
            <div class="logo-text"><span>ChequeTracker</span><span>Management</span></div>
        </div>
        <nav class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-section-title">Main Menu</div>
                <a href="{% url 'dashboard' %}" class="nav-item"><svg viewBox="0 0 24 24"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></svg>Dashboard</a>
                <a href="{% url 'cheque' %}" class="nav-item"><svg viewBox="0 0 24 24"><path d="M19 14V6c0-1.1-.9-2-2-2H3c-1.1 0-2 .9-2 2v8c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zm-9-1c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm13-6v11c0 1.1-.9 2-2 2H4v-2h17V7h2z"/></svg>Cheque In<span class="badge alert" id="pendingBadge">0</span></a>
                <a href="{% url 'deposit' %}" class="nav-item active"><svg viewBox="0 0 24 24"><path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"/></svg>Deposit</a>
                <a href="{% url 'report' %}" class="nav-item"><svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg>Reports</a>
            </div>
            <div class="nav-section">
                <div class="nav-section-title">Settings</div>
                <a href="{% url 'setting' %}" class="nav-item"><svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>Settings</a>
                <a href="{% url 'help' %}" class="nav-item"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>Help & Support</a>
            </div>
        </nav>
        <div class="sidebar-footer">
            <div class="sidebar-user">
                <div class="sidebar-user-avatar"><svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg></div>
                <div class="sidebar-user-info"><div class="sidebar-user-name">John Doe</div><div class="sidebar-user-role">Administrator</div></div>
            </div>
            <a href="{% url 'logout' %}" class="logout-btn"><svg viewBox="0 0 24 24"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></svg>Sign Out</a>
        </div>
    </aside>

    <div class="main-wrapper">
        <header class="header">
            <div class="header-left">
                <h1 class="header-title">Deposit Cheques</h1>
                <p class="header-subtitle">Select cheques, assign banks, upload slips &amp; record deposits</p>
            </div>
            <div class="header-right">
                <div class="header-datetime">
                    <div class="header-time" id="currentTime">00:00</div>
                    <div class="header-date" id="currentDate">Loading...</div>
                </div>
                <div class="header-actions">
                    <button class="header-btn theme-toggle" onclick="toggleTheme()">
                        <svg class="moon" viewBox="0 0 24 24"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-2.98 0-5.4-2.42-5.4-5.4 0-1.81.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z"/></svg>
                        <svg class="sun" viewBox="0 0 24 24"><path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0 .39-.39.39-1.03 0-1.41l-1.06-1.06zm1.06-10.96c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06z"/></svg>
                    </button>
                </div>
            </div>
        </header>

        <main class="main-content">
            <!-- Quick Stats -->
            <div class="quick-stats">
                <div class="quick-stat-card">
                    <div class="quick-stat-icon orange"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg></div>
                    <div class="quick-stat-content"><h4 id="statPending">{{ available_cheque|length }}</h4><p>Pending Cheques</p></div>
                </div>
                <div class="quick-stat-card">
                    <div class="quick-stat-icon blue"><svg viewBox="0 0 24 24"><path d="M19 14V6c0-1.1-.9-2-2-2H3c-1.1 0-2 .9-2 2v8c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zm-9-1c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm13-6v11c0 1.1-.9 2-2 2H4v-2h17V7h2z"/></svg></div>
                    <div class="quick-stat-content"><h4 id="statDeposited">0</h4><p>Total Deposits</p></div>
                </div>
                <div class="quick-stat-card">
                    <div class="quick-stat-icon green"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg></div>
                    <div class="quick-stat-content"><h4 id="statCleared">0</h4><p>Cleared</p></div>
                </div>
                <div class="quick-stat-card">
                    <div class="quick-stat-icon purple"><svg viewBox="0 0 24 24"><path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"/></svg></div>
                    <div class="quick-stat-content"><h4 id="statTotalAmount">NPR 0</h4><p>Total Deposited</p></div>
                </div>
            </div>

            <!-- Step Indicator -->
            <div class="step-indicator">
                <div class="step completed">
                    <div class="step-number"><svg viewBox="0 0 24 24" width="20" height="20" fill="white"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg></div>
                    <div class="step-info"><div class="step-title">Cheque Entry</div><div class="step-subtitle">Record cheque details</div></div>
                </div>
                <div class="step-connector active"></div>
                <div class="step active">
                    <div class="step-number">2</div>
                    <div class="step-info"><div class="step-title">Bank Deposit</div><div class="step-subtitle">Select &amp; deposit cheques</div></div>
                </div>
                <div class="step-connector"></div>
                 <div class="step last">
                    <div class="step-number">3</div>
                    <div class="step-info"><div class="step-title">Report</div><div class="step-subtitle">Generate deposit reports</div></div>
                </div>
                
            </div>

            <!-- Deposit Mode Tabs -->
            <div class="deposit-mode-tabs">
                <button class="deposit-mode-tab active" onclick="switchDepositMode('single')" id="tabSingle">
                    <svg viewBox="0 0 24 24"><path d="M4 10h3v7H4zm6 0h3v7h-3zm-8 9h19v3H2zm14-9h3v7h-3zm-4.5-9L2 6v2h19V6z"/></svg>
                    Cheque Deposit
                </button>
                
            </div>

            <!-- Content Layout -->
            <div class="content-layout">
                <!-- LEFT: Pending Cheques -->
                <div class="pending-cheques-section">
                    <div class="section-header">
                        <div class="section-header-left">
                            <div class="section-header-icon orange"><svg viewBox="0 0 24 24"><path d="M19 14V6c0-1.1-.9-2-2-2H3c-1.1 0-2 .9-2 2v8c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zm-9-1c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm13-6v11c0 1.1-.9 2-2 2H4v-2h17V7h2z"/></svg></div>
                            <div><h3>Pending Cheques</h3><p id="chequeListSubtitle">Select cheques to deposit</p></div>
                        </div>
                        <div class="section-header-right">
                            <div class="select-all-wrapper">
                                <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                                <label for="selectAll">Select All</label>
                            </div>
                        </div>
                    </div>

                    <div class="cheque-list" id="chequeList">
                        {% if available_cheque %}
                            {% for cheque in available_cheque %}
                            <div class="cheque-item"
                                 data-id="{{ cheque.id }}"
                                 data-cheque-no="{{ cheque.cheque_number }}"
                                 data-account-name="{{ cheque.account_name }}"
                                 data-cheque-bank="{{ cheque.cheque_bank }}"
                                 data-amount="{{ cheque.cheque_amount }}"
                                 onclick="toggleChequeSelection(this)">
                                <input type="checkbox" class="cheque-checkbox" onclick="event.stopPropagation()">
                                <div class="cheque-info">
                                    <div class="cheque-detail">
                                        <span class="cheque-detail-label">Cheque No</span>
                                        <span class="cheque-detail-value highlight">{{ cheque.cheque_number }}</span>
                                    </div>
                                    <div class="cheque-detail">
                                        <span class="cheque-detail-label">Issued By</span>
                                        <span class="cheque-detail-value">{{ cheque.account_name }}</span>
                                    </div>
                                    <div class="cheque-detail">
                                        <span class="cheque-detail-label">Cheque Bank</span>
                                        <span class="cheque-detail-value">{{ cheque.cheque_bank }}</span>
                                    </div>
                                    <div class="cheque-detail">
                                        <span class="cheque-detail-label">Amount</span>
                                        <span class="cheque-detail-value amount">NPR {{ cheque.cheque_amount }}</span>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="empty-state">
                                <div class="empty-state-icon"><svg viewBox="0 0 24 24"><path d="M19 14V6c0-1.1-.9-2-2-2H3c-1.1 0-2 .9-2 2v8c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zm-9-1c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm13-6v11c0 1.1-.9 2-2 2H4v-2h17V7h2z"/></svg></div>
                                <h4>No Pending Cheques</h4>
                                <p>All cheques have been deposited or none have been added yet.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- RIGHT: Deposit Form -->
                <div class="deposit-form-section" id="singleBankForm">
                    <div class="deposit-form-header">
                        <h3><svg viewBox="0 0 24 24"><path d="M4 10h3v7H4zm6 0h3v7h-3zm-8 9h19v3H2zm14-9h3v7h-3zm-4.5-9L2 6v2h19V6z"/></svg>Deposit Details</h3>
                        <p>Enter bank details &amp; upload deposit slip</p>
                    </div>

                    <!-- Summary Stats -->
                    <div class="selected-summary">
                        <div class="selected-summary-title">Selected Cheques Summary</div>
                        <div class="selected-stats">
                            <div class="selected-stat">
                                <div class="selected-stat-value" id="selectedCount">0</div>
                                <div class="selected-stat-label">Cheques Selected</div>
                            </div>
                            <div class="selected-stat">
                                <div class="selected-stat-value amount" id="selectedAmount">NPR 0</div>
                                <div class="selected-stat-label">Total Amount</div>
                            </div>
                        </div>
                    </div>

                    <!-- Deposit Form Fields -->
                    <form class="deposit-form" id="depositForm" action="{% url 'deposit_form' %}" method="POST" enctype="multipart/form-data">
                        {% csrf_token %}
                        <input type="hidden" name="selected_cheque_ids" id="selectedChequeIds" value="">

                        <!-- Cheque Info Fields (auto-filled + editable) -->
                        <div class="form-section-divider">
                            <span>Cheque Information</span>
                            <small>Click a cheque on the left to auto-fill</small>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Cheque No.</label>
                                <input type="text" name="cheque_number" class="form-input" id="field_chequeNo" placeholder="Click a cheque ">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Issued By</label>
                                <input type="text" name="account_name" class="form-input" id="field_issuedBy" placeholder="Account name">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Cheque Bank</label>
                                <input type="text" name="cheque_bank" class="form-input" id="field_chequeBank" placeholder="Cheque bank name">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Amount (NPR)</label>
                                <input type="number" name="cheque_amount" class="form-input" id="field_amount" placeholder="0.00" min="0" step="0.01">
                            </div>
                        </div>

                        <!-- Deposit Info Fields -->
                        <div class="form-section-divider" style="margin-top: 8px;">
                            <span>Deposit Information</span>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Deposit Bank <span class="required">*</span></label>
                            <select name="deposit_bank" class="form-select" id="depositBank" required>
                                <option value="">Select deposit bank</option>
                                <optgroup label="Class A - Commercial Banks">
                                    <option value="Nabil Bank">Nabil Bank Limited</option>
                                    <option value="Nepal Investment Mega Bank">Nepal Investment Mega Bank Limited</option>
                                    <option value="Standard Chartered Bank">Standard Chartered Bank Nepal Limited</option>
                                    <option value="Himalayan Bank">Himalayan Bank Limited</option>
                                    <option value="Nepal SBI Bank">Nepal SBI Bank Limited</option>
                                    <option value="Nepal Bank">Nepal Bank Limited</option>
                                    <option value="Rastriya Banijya Bank">Rastriya Banijya Bank Limited</option>
                                    <option value="Everest Bank">Everest Bank Limited</option>
                                    <option value="NIC Asia Bank">NIC Asia Bank Limited</option>
                                    <option value="Machhapuchchhre Bank">Machhapuchchhre Bank Limited</option>
                                    <option value="Kumari Bank">Kumari Bank Limited</option>
                                    <option value="Laxmi Sunrise Bank">Laxmi Sunrise Bank Limited</option>
                                    <option value="Siddhartha Bank">Siddhartha Bank Limited</option>
                                    <option value="Global IME Bank">Global IME Bank Limited</option>
                                    <option value="Citizens Bank">Citizens Bank International Limited</option>
                                    <option value="Prime Commercial Bank">Prime Commercial Bank Limited</option>
                                    <option value="NMB Bank">NMB Bank Limited</option>
                                    <option value="Prabhu Bank">Prabhu Bank Limited</option>
                                    <option value="Sanima Bank">Sanima Bank Limited</option>
                                </optgroup>
                                <optgroup label="Class B - Development Banks">
                                    <option value="Kamana Sewa Bikas Bank">Kamana Sewa Bikas Bank Limited</option>
                                    <option value="Muktinath Bikas Bank">Muktinath Bikas Bank Limited</option>
                                    <option value="Lumbini Bikas Bank">Lumbini Bikas Bank Limited</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Branch Name <span class="required">*</span></label>
                            <input type="text" class="form-input" name="branch_name" id="branchName" placeholder="e.g., Kathmandu Main Branch" required>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Deposit Date <span class="required">*</span></label>
                                <input type="date" class="form-input" name="deposit_date" id="depositDate" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Deposit Slip No.</label>
                                <input type="text" class="form-input" name="deposit_slip_no" id="depositSlipNo" placeholder="e.g., DS-12345">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Account Number</label>
                            <input type="text" class="form-input" id="accountNumber" placeholder="Your account number">
                        </div>

                        <!-- File Upload -->
                        

                        <div class="form-group">
                            <label class="form-label">Remarks</label>
                            <textarea class="form-textarea" id="depositRemarks" placeholder="Any additional notes..." name="remarks"></textarea>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-success" id="submitDeposit" disabled>
                                <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                                Record Deposit
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Deposit History -->
            <div class="deposit-history-section">
                <div class="section-header">
                    <div class="section-header-left">
                        <div class="section-header-icon green"><svg viewBox="0 0 24 24"><path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/></svg></div>
                        <div><h3>Deposit History</h3><p>View all your deposit records</p></div>
                    </div>
                    <div class="section-header-right">
                        <button class="btn btn-excel" onclick="exportDepositsToExcel()">
                            <svg viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M21.17 3.25Q21.5 3.25 21.76 3.5 22 3.74 22 4.08V19.92Q22 20.26 21.76 20.5 21.5 20.75 21.17 20.75H7.83Q7.5 20.75 7.24 20.5 7 20.26 7 19.92V17H2.83Q2.5 17 2.24 16.76 2 16.5 2 16.17V7.83Q2 7.5 2.24 7.24 2.5 7 2.83 7H7V4.08Q7 3.74 7.24 3.5 7.5 3.25 7.83 3.25M7 13.06L8.18 15.28H9.97L8 12.06L9.93 8.89H8.22L7.13 10.9L7.09 10.96L7.06 11.03Q6.8 10.5 6.5 9.96 6.25 9.43 5.97 8.89H4.16L6.05 12.08L4 15.28H5.78M13.88 19.5V17H8.25V19.5M13.88 15.75V12.63H12V15.75M13.88 11.38V8.25H12V11.38M13.88 7V4.5H8.25V7M20.75 19.5V17H15.13V19.5M20.75 15.75V12.63H15.13V15.75M20.75 11.38V8.25H15.13V11.38M20.75 7V4.5H15.13V7Z"/></svg>
                            Export to Excel
                        </button>
                    </div>
                </div>
                <div class="table-wrapper">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Cheque NO</th>
                                <th>Deposit Bank</th>
                                <th>Branch</th>
                                
                                <th>Total Amount</th>
                                <th>Deposit Date</th>
                                <th>Deposit Slip</th>
                                <th>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="depositHistoryBody">
                            
                            
                            {% for cheque_deposits in cheque_deposits %}
                            <tr>
                               
                                <td class="deposit-id">{{ cheque_deposits.cheque_number }}</td>
                                <td>{{ cheque_deposits.deposit_bank }}</td>
                                <td>{{ cheque_deposits.branch_name }}</td>
                               
                                <td class="deposit-amount">{{ cheque_deposits.cheque_amount }}</td>
                                <td>{{ cheque_deposits.deposit_date }}</td>
                                <td>{{cheque_deposits.deposit_slip_no}}</td>
                                <td><span class="table-status">Deposited</span></td>
                                <td>
                                    <div class="table-actions">
                                        <a href="{% url 'deposit_delete' cheque_deposits.id %}">
                                            <button type="submit" class="table-action-btn delete-btn" title="Delete">
                                                    <svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                                            </button>
                                        </a>        
                                    </div>
                                </td>
                                
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
        <footer class="footer"><p> 2026 ChequeTracker. All rights reserved.</p></footer>
    </div>

    <!-- View Modal -->
    <div class="modal-overlay" id="viewModal">
        <div class="modal">
            <div class="modal-header"><h3>Deposit Details</h3><button class="modal-close" onclick="closeViewModal()"><svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button></div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <!-- Image Preview -->
    <div class="image-preview-overlay" id="imagePreview" onclick="closeImagePreview()">
        <button class="image-preview-close"><svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button>
        <img id="previewImage" src="" alt="Preview">
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <script>
    // ==================== STATE ====================
    const DEPOSITS_KEY = 'chequeDepositsData_v2';
    let depositRecords = JSON.parse(localStorage.getItem(DEPOSITS_KEY) || '[]');
    let selectedCheques = new Map(); // id -> {chequeNo, accountName, chequeBank, amount}
    let singleUploadedFiles = [];

    // ==================== HELPERS ====================
    function formatNPR(num) {
        const n = Math.floor(parseFloat(num) || 0).toString();
        let r = '', c = 0;
        for (let i = n.length - 1; i >= 0; i--) {
            c++;
            r = n[i] + r;
            if (c === 3 && i !== 0) r = ',' + r;
            else if (c > 3 && (c - 3) % 2 === 0 && i !== 0) r = ',' + r;
        }
        return 'NPR ' + r;
    }
    function formatDate(d) { return new Date(d).toLocaleDateString('en-US', { month:'short', day:'numeric', year:'numeric' }); }
    function formatFileSize(b) { if(b<1024)return b+'B'; if(b<1048576)return(b/1024).toFixed(1)+'KB'; return(b/1048576).toFixed(1)+'MB'; }
    function generateDepositId() { const d=new Date(); return `DEP-${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}-${String(Math.floor(Math.random()*1000)).padStart(3,'0')}`; }

    // ==================== CHEQUE SELECTION + AUTOFILL ====================
    let lastSelectedId = null;

    function toggleChequeSelection(el) {
        const cb = el.querySelector('.cheque-checkbox');
        const id = el.dataset.id;
        const data = {
            chequeNo:    el.dataset.chequeNo,
            accountName: el.dataset.accountName,
            chequeBank:  el.dataset.chequeBank,
            amount:      parseFloat(el.dataset.amount) || 0
        };

        if (selectedCheques.has(id)) {
            // Deselecting
            selectedCheques.delete(id);
            el.classList.remove('selected');
            cb.checked = false;
            // If this was the one filling the form, clear or fill from next selected
            if (lastSelectedId === id) {
                lastSelectedId = null;
                if (selectedCheques.size > 0) {
                    const [nextId, nextData] = selectedCheques.entries().next().value;
                    autofillFields(nextId, nextData);
                } else {
                    clearFields();
                }
            }
        } else {
            // Selecting  always autofill with clicked cheque
            selectedCheques.set(id, data);
            el.classList.add('selected');
            cb.checked = true;
            autofillFields(id, data);
        }

        updateSummary();
        updateSelectAllCheckbox();
    }

    function autofillFields(id, data) {
        lastSelectedId = id;
        const fields = [
            { el: document.getElementById('field_chequeNo'),   val: data.chequeNo    },
            { el: document.getElementById('field_issuedBy'),   val: data.accountName },
            { el: document.getElementById('field_chequeBank'), val: data.chequeBank  },
            { el: document.getElementById('field_amount'),     val: data.amount      },
        ];
        fields.forEach(({ el, val }) => {
            if (!el) return;
            el.value = val || '';
            el.classList.add('autofilled');
        });
    }

    function clearFields() {
        ['field_chequeNo','field_issuedBy','field_chequeBank','field_amount'].forEach(id => {
            const el = document.getElementById(id);
            if (!el) return;
            el.value = '';
            el.classList.remove('autofilled');
        });
        lastSelectedId = null;
    }

    function deselectCheque(id) {
        selectedCheques.delete(id);
        const el = document.querySelector(`.cheque-item[data-id="${id}"]`);
        if (el) {
            el.classList.remove('selected');
            el.querySelector('.cheque-checkbox').checked = false;
        }
        if (lastSelectedId === id) {
            if (selectedCheques.size > 0) {
                const [nextId, nextData] = selectedCheques.entries().next().value;
                autofillFields(nextId, nextData);
            } else {
                clearFields();
                return;
            }
        }
        updateSummary();
        updateSelectAllCheckbox();
    }

    function toggleSelectAll() {
        const sa = document.getElementById('selectAll');
        const items = document.querySelectorAll('.cheque-item[data-id]');
        if (sa.checked) {
            items.forEach(el => {
                const id = el.dataset.id;
                if (!selectedCheques.has(id)) {
                    selectedCheques.set(id, {
                        chequeNo:    el.dataset.chequeNo,
                        accountName: el.dataset.accountName,
                        chequeBank:  el.dataset.chequeBank,
                        amount:      parseFloat(el.dataset.amount) || 0
                    });
                    el.classList.add('selected');
                    el.querySelector('.cheque-checkbox').checked = true;
                }
            });
            // Autofill with the first item if none loaded yet
            if (items.length > 0 && !lastSelectedId) {
                const first = items[0];
                autofillFields(first.dataset.id, {
                    chequeNo:    first.dataset.chequeNo,
                    accountName: first.dataset.accountName,
                    chequeBank:  first.dataset.chequeBank,
                    amount:      parseFloat(first.dataset.amount) || 0
                });
            }
        } else {
            items.forEach(el => {
                el.classList.remove('selected');
                el.querySelector('.cheque-checkbox').checked = false;
            });
            selectedCheques.clear();
            clearFields();
            return;
        }
        updateSummary();
    }

    function updateSelectAllCheckbox() {
        const sa = document.getElementById('selectAll');
        const items = document.querySelectorAll('.cheque-item[data-id]');
        sa.checked = items.length > 0 && [...items].every(el => selectedCheques.has(el.dataset.id));
    }

    // ==================== SUMMARY ====================
    function updateSummary() {
        const count = selectedCheques.size;
        let total = 0;
        selectedCheques.forEach(d => total += d.amount);
        document.getElementById('selectedCount').textContent = count;
        document.getElementById('selectedAmount').textContent = formatNPR(total);
        document.getElementById('submitDeposit').disabled = count === 0;
    }


    // ==================== FILE UPLOAD ====================
    function handleFileUpload(e) {
        Array.from(e.target.files).forEach(file => {
            if (file.size > 5 * 1024 * 1024) { showToast('error', 'File Too Large', `${file.name} exceeds 5MB.`); return; }
            const reader = new FileReader();
            reader.onload = ev => { singleUploadedFiles.push({ name:file.name, size:file.size, dataUrl:ev.target.result, type:file.type }); renderUploadedFiles(); };
            reader.readAsDataURL(file);
        });
        e.target.value = '';
    }
    function removeUploadedFile(i) { singleUploadedFiles.splice(i, 1); renderUploadedFiles(); }
    function renderUploadedFiles() {
        const c = document.getElementById('singleUploadedFiles');
        if (!singleUploadedFiles.length) { c.innerHTML = ''; return; }
        c.innerHTML = singleUploadedFiles.map((f,i) => `
            <div class="uploaded-file-item">
                <div class="uploaded-file-thumb">
                    ${f.type && f.type.startsWith('image/') ? `<img src="${f.dataUrl}" onclick="previewImage('${f.dataUrl}')" style="cursor:zoom-in" alt="">` : `<svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zM6 20V4h7v5h5v11H6z"/></svg>`}
                </div>
                <div class="uploaded-file-info">
                    <div class="uploaded-file-name">${f.name}</div>
                    <div class="uploaded-file-size">${formatFileSize(f.size)}</div>
                </div>
                <button class="uploaded-file-remove" onclick="removeUploadedFile(${i})">
                    <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                </button>
            </div>`).join('');
    }
    function previewImage(src) { document.getElementById('previewImage').src = src; document.getElementById('imagePreview').classList.add('active'); }
    function closeImagePreview() { document.getElementById('imagePreview').classList.remove('active'); }

    // Drag & drop
    (() => {
        const area = document.getElementById('singleUploadArea');
        if (!area) return;
        ['dragenter','dragover'].forEach(ev => area.addEventListener(ev, e => { e.preventDefault(); area.classList.add('dragover'); }));
        ['dragleave','drop'].forEach(ev => area.addEventListener(ev, e => { e.preventDefault(); area.classList.remove('dragover'); }));
        area.addEventListener('drop', e => {
            if (e.dataTransfer.files.length) handleFileUpload({ target: { files: e.dataTransfer.files, value:'' }, target: { files: e.dataTransfer.files } });
        });
    })();

    // ==================== DEPOSIT SUBMIT ====================
    function handleSingleDeposit(e) {
        e.preventDefault();
        if (selectedCheques.size === 0) { showToast('error','No Cheques','Select at least one cheque.'); return; }
        const bank   = document.getElementById('depositBank').value;
        const branch = document.getElementById('branchName').value;
        const date   = document.getElementById('depositDate').value;
        if (!bank || !branch || !date) { showToast('error','Missing Info','Fill all required fields.'); return; }

        // Read the (possibly edited) cheque field values
        const editedChequeNo    = document.getElementById('field_chequeNo').value.trim();
        const editedAccountName = document.getElementById('field_issuedBy').value.trim();
        const editedChequeBank  = document.getElementById('field_chequeBank').value.trim();
        const editedAmount      = parseFloat(document.getElementById('field_amount').value) || 0;

        const chequesData = [];
        let total = 0;
        selectedCheques.forEach((data, id) => {
            // If this is the "active" cheque (lastSelectedId), use edited values
            const isActive = id === lastSelectedId;
            const chequeNo    = isActive && editedChequeNo    ? editedChequeNo    : data.chequeNo;
            const accountName = isActive && editedAccountName ? editedAccountName : data.accountName;
            const chequeBank  = isActive && editedChequeBank  ? editedChequeBank  : data.chequeBank;
            const amount      = isActive && editedAmount      ? editedAmount      : data.amount;
            chequesData.push({ id, chequeNo, accountName, chequeBank, amount });
            total += amount;
        });

        depositRecords.unshift({
            depositId:    generateDepositId(),
            depositBank:  bank,
            branchName:   branch,
            depositDate:  date,
            depositSlipNo:  document.getElementById('depositSlipNo').value,
            accountNumber:  document.getElementById('accountNumber').value,
            remarks:        document.getElementById('depositRemarks').value,
            cheques:        chequesData,
            totalAmount:    total,
            status:         'processing',
            createdAt:      new Date().toISOString(),
            slipImages:     singleUploadedFiles.map(f => ({ name:f.name, dataUrl:f.dataUrl, type:f.type }))
        });

        localStorage.setItem(DEPOSITS_KEY, JSON.stringify(depositRecords));

        // Hide deposited cheques from the list
        chequesData.forEach(c => {
            const el = document.querySelector(`.cheque-item[data-id="${c.id}"]`);
            if (el) el.style.display = 'none';
        });

        selectedCheques.clear();
        singleUploadedFiles = [];
        lastSelectedId = null;
        e.target.reset();
        document.getElementById('depositDate').value = new Date().toISOString().split('T')[0];
        clearFields();
        renderUploadedFiles();

        updateSummary();
        updateSelectAllCheckbox();
        renderDepositHistory();
        updateStats();
        showToast('success','Deposit Recorded!',`${chequesData.length} cheque(s) totaling ${formatNPR(total)} recorded at ${bank}.`);
    }

    // ==================== DEPOSIT HISTORY ====================
    function renderDepositHistory() {
        const tbody = document.getElementById('depositHistoryBody');
        if (!depositRecords.length) {
            tbody.innerHTML = `<tr><td colspan="9" style="text-align:center;padding:40px;color:var(--text-muted);">No deposit records yet.</td></tr>`;
            return;
        }
        /*tbody.innerHTML = depositRecords.map((d, i) => `
            <tr>
                <td class="deposit-id">${d.depositId}</td>
                <td>${d.depositBank}</td>
                <td>${d.branchName}</td>
                <td><span class="deposit-cheques-count"><svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor"><path d="M19 14V6c0-1.1-.9-2-2-2H3c-1.1 0-2 .9-2 2v8c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2z"/></svg>${d.cheques.length}</span></td>
                <td class="deposit-amount">${formatNPR(d.totalAmount)}</td>
                <td>${formatDate(d.depositDate)}</td>
                <td>${d.slipImages && d.slipImages.length ? `<span class="has-slip-icon"><svg viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>${d.slipImages.length}</span>` : `<span class="no-slip-icon"></span>`}</td>
                <td><span class="table-status ${d.status}"><span class="cheque-status-dot"></span>${d.status.charAt(0).toUpperCase()+d.status.slice(1)}</span></td>
                <td><div class="table-actions"><button class="table-action-btn view" onclick="viewDeposit(${i})" title="View"><svg viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg></button></div></td>
            </tr>`).join('');
            */
    }

    function updateStats() {
        const pending = document.querySelectorAll('.cheque-item[data-id]:not([style*="display: none"])').length;
        document.getElementById('statPending').textContent = pending;
        document.getElementById('statDeposited').textContent = depositRecords.length;
        let totalDep = 0;
        depositRecords.forEach(d => totalDep += parseFloat(d.totalAmount) || 0);
        document.getElementById('statTotalAmount').textContent = formatNPR(totalDep);
    }

    // ==================== VIEW MODAL ====================
    function viewDeposit(i) {
        const d = depositRecords[i];
        document.getElementById('modalBody').innerHTML = `
            <div class="modal-section">
                <div class="modal-section-title">Deposit Information</div>
                <div class="modal-info-grid">
                    <div class="modal-info-item"><div class="modal-info-label">Deposit ID</div><div class="modal-info-value highlight">${d.depositId}</div></div>
                    <div class="modal-info-item"><div class="modal-info-label">Date</div><div class="modal-info-value">${formatDate(d.depositDate)}</div></div>
                    <div class="modal-info-item"><div class="modal-info-label">Bank</div><div class="modal-info-value">${d.depositBank}</div></div>
                    <div class="modal-info-item"><div class="modal-info-label">Branch</div><div class="modal-info-value">${d.branchName}</div></div>
                    <div class="modal-info-item"><div class="modal-info-label">Slip No.</div><div class="modal-info-value">${d.depositSlipNo||'N/A'}</div></div>
                    <div class="modal-info-item"><div class="modal-info-label">Account</div><div class="modal-info-value">${d.accountNumber||'N/A'}</div></div>
                    <div class="modal-info-item"><div class="modal-info-label">Total Amount</div><div class="modal-info-value amount">${formatNPR(d.totalAmount)}</div></div>
                    <div class="modal-info-item"><div class="modal-info-label">Status</div><div class="modal-info-value"><span class="table-status ${d.status}"><span class="cheque-status-dot"></span>${d.status.charAt(0).toUpperCase()+d.status.slice(1)}</span></div></div>
                </div>
                ${d.remarks ? `<div class="modal-info-item" style="margin-top:14px;"><div class="modal-info-label">Remarks</div><div class="modal-info-value">${d.remarks}</div></div>` : ''}
            </div>
            ${d.slipImages && d.slipImages.length ? `
            <div class="modal-section">
                <div class="modal-section-title">Deposit Slip(s)</div>
                <div class="modal-slip-grid">
                    ${d.slipImages.map(s => `<div class="modal-slip-thumb" onclick="previewImage('${s.dataUrl}')">
                        ${s.type && s.type.startsWith('image/') ? `<img src="${s.dataUrl}" alt="${s.name}">` : `<div style="display:flex;align-items:center;justify-content:center;height:100%;background:var(--bg-secondary);"><svg viewBox="0 0 24 24" width="36" height="36" fill="var(--text-muted)"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zM6 20V4h7v5h5v11H6z"/></svg></div>`}
                    </div>`).join('')}
                </div>
            </div>` : ''}
            <div class="modal-section">
                <div class="modal-section-title">Cheques in this Deposit (${d.cheques.length})</div>
                <div class="modal-cheques-list">
                    <div class="modal-cheque-item header"><span>Cheque No.</span><span>Issued By</span><span>Cheque Bank</span><span>Amount</span></div>
                    ${d.cheques.map(c => `<div class="modal-cheque-item">
                        <span style="font-weight:700;color:var(--primary)">${c.chequeNo}</span>
                        <span>${c.accountName}</span>
                        <span>${c.chequeBank}</span>
                        <span style="font-weight:700;color:var(--success)">${formatNPR(c.amount)}</span>
                    </div>`).join('')}
                </div>
            </div>`;
        document.getElementById('viewModal').classList.add('active');
    }
    function closeViewModal() { document.getElementById('viewModal').classList.remove('active'); }

    // ==================== EXPORT ====================
    function exportDepositsToExcel() {
        if (!depositRecords.length) { showToast('error','No Data','Nothing to export.'); return; }
        const data = [];
        depositRecords.forEach(d => d.cheques.forEach(c => {
            data.push({
                'Deposit ID':d.depositId,'Deposit Bank':d.depositBank,'Branch':d.branchName,
                'Deposit Date':formatDate(d.depositDate),'Slip No.':d.depositSlipNo||'',
                'Account':d.accountNumber||'','Cheque No.':c.chequeNo,
                'Issued By':c.accountName,'Cheque Bank':c.chequeBank,'Amount':c.amount,
                'Has Slip':d.slipImages&&d.slipImages.length?'Yes':'No','Remarks':d.remarks||''
            });
        }));
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(data);
        ws['!cols'] = Array(12).fill({ wch: 18 });
        XLSX.utils.book_append_sheet(wb, ws, 'Deposits');
        const fn = `Deposits_${new Date().toISOString().split('T')[0]}.xlsx`;
        XLSX.writeFile(wb, fn);
        showToast('success','Exported',`Saved as ${fn}`);
    }

    // ==================== MODE SWITCHING (stub, single mode only for now) ====================
    function switchDepositMode(mode) {
        document.getElementById('tabSingle').classList.toggle('active', mode==='single');
        /*document.getElementById('tabMulti').classList.toggle('active', mode==='multi');*/
        document.getElementById('chequeListSubtitle').textContent = mode==='single'
            ? 'Select cheques to deposit at a single bank'
            : 'Select cheques, then assign them to different banks';
    }

    // ==================== TOAST ====================
    function showToast(type, title, message) {
        const c = document.getElementById('toastContainer');
        const t = document.createElement('div'); t.className = `toast ${type}`;
        const icons = { success:'<path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>', error:'<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>', warning:'<path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/>' };
        t.innerHTML = `<div class="toast-icon"><svg viewBox="0 0 24 24">${icons[type]||icons.error}</svg></div><div class="toast-content"><div class="toast-title">${title}</div><div class="toast-message">${message}</div></div><button class="toast-close" onclick="this.parentElement.remove()"><svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button>`;
        c.appendChild(t);
        setTimeout(() => { t.style.animation = 'slideOutRight 0.3s ease-out forwards'; setTimeout(() => t.remove(), 300); }, 5000);
    }

    // ==================== THEME & TIME ====================
    function toggleTheme() {
        const cur = document.body.getAttribute('data-theme');
        document.body.setAttribute('data-theme', cur==='dark' ? '' : 'dark');
        localStorage.setItem('theme', cur==='dark' ? 'light' : 'dark');
    }
    function updateTime() {
        const n = new Date();
        document.getElementById('currentTime').textContent = n.toLocaleTimeString('en-US', { hour:'2-digit', minute:'2-digit', hour12:true });
        document.getElementById('currentDate').textContent = n.toLocaleDateString('en-US', { weekday:'short', month:'short', day:'numeric' });
    }

    // ==================== INIT ====================
    window.addEventListener('load', () => {
        if (localStorage.getItem('theme') === 'dark') document.body.setAttribute('data-theme', 'dark');
        document.getElementById('depositDate').value = new Date().toISOString().split('T')[0];
        renderDepositHistory();
        updateStats();
        updateTime();
        setInterval(updateTime, 1000);
    });
    // ==================== FORM SUBMIT: POPULATE HIDDEN IDS ====================
    document.getElementById('depositForm').addEventListener('submit', function(e) {
        if (selectedCheques.size === 0) {
            e.preventDefault();
            showToast('error', 'No Cheques', 'Select at least one cheque.');
            return;
        }
    
        const bank   = document.getElementById('depositBank').value;
        const branch = document.getElementById('branchName').value;
        const date   = document.getElementById('depositDate').value;
    
        if (!bank || !branch || !date) {
            e.preventDefault();
            showToast('error', 'Missing Info', 'Fill all required fields (Bank, Branch, Date).');
            return;
        }
    
        // Populate the hidden input with comma-separated IDs
        const ids = [...selectedCheques.keys()].join(',');
        document.getElementById('selectedChequeIds').value = ids;
    
        // Allow the form to submit normally to Django
    });

    document.getElementById('viewModal').addEventListener('click', function(e) { if(e.target===this) closeViewModal(); });
    document.addEventListener('keydown', e => { if(e.key==='Escape'){ closeViewModal(); closeImagePreview(); } });
    </script>
</body>
</html>